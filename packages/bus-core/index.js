require("source-map-support/register"),module.exports=function(e){var t={};function o(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,o),s.l=!0,s.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)o.d(r,s,function(t){return e[t]}.bind(null,s));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=5)}([function(e,t){e.exports={filter_request_body(e){const t={};if(e)return function(e,o){for(const r in e)e.hasOwnProperty(r)&&(o.some(e=>r===e)||(t[r]=e[r]));return t}(e,["created_date","updated_date","creator_name","creator_id","_id"])},compact(e){let t;if(console.log("compact",Object.prototype.toString.call(e)),"[object Object]"===Object.prototype.toString.call(e)){t={};for(const o in e)e[o]&&(t[o]=e[o])}else"[object Array]"===Object.prototype.toString.call(e)&&(t=[],e.forEach(e=>{e&&t.push(e)}));return t},unless({url:e,method:t},o){function r(e){return!e||Array.isArray(e)?e:[e]}return o.some(function(o){var s=o.methods||r(o.method);return function e(t,o){var r="string"==typeof t&&t===o||t instanceof RegExp&&!!t.exec(o);return t instanceof RegExp&&(t.lastIndex=0),t&&t.url&&(r=e(t.url,o)),r}(o,e)&&function(e,t){return!e||(e=r(e)).indexOf(t)>-1}(s,t)})}}},function(e,t){let o={UNKNOW_ERROR:"unknowError",PARAMS_ERROR:"paramsError",RESOURCES_EXIST:"resourcesExist",USER_NOT_PERMISSIONS:"userNotPermissions",RESOURCES_NOT_EXIST:"resourcesNotExist",SERVER_ERROR:"serverError"};const r=new Map;r.set(o.PARAMS_ERROR,{status:400,message:"Request parameter is wrong"}),r.set(o.RESOURCES_EXIST,{status:400,message:"Data already exists"}),r.set(o.USER_NOT_PERMISSIONS,{status:401,message:"User has no permissions"}),r.set(o.RESOURCES_NOT_EXIST,{status:404,message:"There is no resources"}),r.set(o.SERVER_ERROR,{status:500,message:"Internal Server Error"}),o.getErrorInfo=(e=>{let t;return e&&(t=r.get(e)),t||(e=o.UNKNOW_ERROR,t=r.get(e)),t}),e.exports=o},function(e,t,o){const r=o(1);e.exports=class extends Error{constructor(e,t,o){super();let s="",n="";if(null!==e){const t=r.getErrorInfo(e);s=t.status,n=t.message}else s=t,n=o;this.name=e,this.status=s,this.message=n}}},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("mongoose")},function(e,t,o){function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}const s=o(6),n=o(14),i=o(3)(),c=o(16),u=o(18),a=o(20);e.exports=class{constructor({config:e,Model:t,Schema:o,Api:l}){r(this,"initMongo",async()=>{a.init(this.config.mongodb);const{schemas:e,examples:t}=await this.Schema.init(this);this.schemas=e,this.examples=t;const o=await this.Model.init(this);this.models=o}),r(this,"initRouter",async()=>{console.log("initRouter");let{secret:e,excludeCheckUrl:t}=this.config;this.Token=new u({secret:e,rules:t});const o=await this.Api.init(this);this.router.use(`/${this.config.apiPrefix}`,o.routes(),o.allowedMethods())}),r(this,"initApp",async()=>(console.log("initApp1"),await this.initMongo(),await this.initRouter(),console.log("initApp2"),s.call(this,this.router))),r(this,"start",async()=>(console.log("start"),this.app=await this.initApp(),console.log("start2"),n.call(this,this.app))),this.config=e?Object.assign(c,e):c,this.router=i,this.Model=t,this.Schema=o,this.Api=l}}},function(e,t,o){const r=new(o(7)),s=o(8),n=o(9),i=o(10),c=o(11),u=o(12),a=o(13);c(r),e.exports=function(e){return r.use(i()),r.use(n({enableTypes:["json","form"]})),r.use(s()),r.use(async(e,t)=>{const o=new Date;await t();const r=new Date-o;console.log(`${e.method} ${e.url} - ${r}ms`)}),r.use(a.bind(this)),r.use(e.routes(),e.allowedMethods()),r.on("error",u),r}},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("koa-json")},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("koa2-cors")},function(e,t){e.exports=require("koa-onerror")},function(e,t){e.exports=((e,t)=>{const o=new Date,r=new Date-o;console.warn(`${t.method} ${t.url} - ${r}ms`)})},function(e,t,o){const{filter_request_body:r}=o(0),s=o(2);e.exports=async function(e,t){try{let o=this.config.apiPrefix;if(new RegExp(`^/${o}`).test(e.url)){let t=this.Token;if(t.checkUrl(e)){if(!e.request.header.authorization)throw new s(null,401,"There is no token");{let o=e.request.header.authorization.split(" ")[1];console.log("Token",t);const r=t.decode({token:o});if(console.log("decoded",r),!r)throw new s(null,401,"Auth failed");this.onTokenCheck&&(e.state=this.onTokenCheck(r)),e.state=e.state||r}}e.request.body=r(e.request.body)}await t(),0===e.url.indexOf(`/${o}`)&&e.url.indexOf(`/${o}/swagger`)<0&&e.body&&(e.body={success:!0,data:e.body}),404===e.status&&(e.body={success:!1,data:new s("resourcesNotExist")},e.status=404)}catch(t){console.warn("api_handel error",t),e.response.status=t.status||500,e.body={success:!1,data:{message:t.message}}}}},function(e,t,o){const r=o(15);e.exports=function(e){let{port:t}=this.config;t=function(e){var t=parseInt(e,10);if(isNaN(t))return e;if(t>=0)return t;return!1}(t||"3000"),console.log("port",t);var o=r.createServer(e.callback());return new Promise((r,s)=>{o.on("error",function(e){!function(e){if(console.log("onError",e),"listen"!==e.syscall)throw e;var o="string"==typeof t?"Pipe "+t:"Port "+t;switch(e.code){case"EACCES":console.error(o+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(o+" is already in use"),process.exit(1);break;default:throw e}}(e),s(e)}),o.on("listening",function(){!function(){var e=o.address(),t="string"==typeof e?"pipe "+e:"port "+e.port;console.log("Listening on "+t)}(),r(e)}),o.listen(t)})}},function(e,t){e.exports=require("http")},function(e,t,o){const r=o(17),s=r.resolve(process.cwd()),n=r.join(s,"build"),i=r.join(n,"public");e.exports={port:3333,rootPath:s,buildPath:n,publicBuildPath:i,serverSrcPath:r.join(s,"src"),serverBuildPath:n,userNodeModulesPath:r.join(s,"node_modules"),publicPath:"/",logsPath:r.join(s,"logs"),mongodb:{url:"mongodb://localhost:27017/test",options:{}},apiPrefix:"api"}},function(e,t){e.exports=require("path")},function(e,t,o){function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}const s=o(19),{unless:n}=o(0);e.exports=class{constructor(e={secret:"",rules:[]}){r(this,"create",({info:e,secret:t=this.secret,expiresIn:o})=>s.sign(e,t,{expiresIn:o})),r(this,"decode",({token:e,secret:t=this.secret})=>{if(e){let o=s.decode(e,t);if(e&&o.exp>new Date/1e3)return o}}),r(this,"addCheckRules",e=>{let t=Object.prototype.toString.call(e);"[object Array]"===t?this.rules=this.rules.concat(e):"[object String]"===t&&this.rules.push(e)}),r(this,"checkUrl",({url:e,method:t})=>e.indexOf("swagger-")<0&&!n({url:e,method:t},this.rules)),this.rules=e.rules||[],this.secret=e.secret||""}}},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,o){const r=o(4),s={useNewUrlParser:!0,autoIndex:!1,reconnectTries:30,reconnectInterval:500,poolSize:10,bufferMaxEntries:0,connectTimeoutMS:1e4,socketTimeoutMS:45e3,family:4};e.exports=new class{init(e){console.log("mongodb url",e.url),r.connect(e.url,Object.assign(e.options||{},s));const t=r.connection;r.Promise=global.Promise,t.on("error",e=>{console.log("数据库连接出错!",e)}),t.on("open",()=>{console.log("数据库连接成功!")})}}}]);
//# sourceMappingURL=index.js.map